{% extends 'order/base.html' %}
{% load static %}
{% block title %}研狗插件{% endblock %}

{% load i18n %}
{% load account socialaccount %}
{% load widget_tweaks %}

{#{%  block extend_style %}#}
{#    <link rel="stylesheet" type="text/css" href="{% static "app/lib/bootstrap-4.6.1/css/bootstrap.min.css" %}">#}
{#{% endblock %}#}
{##}
{#{%  block extend_js %}#}
{#    <script type="text/javascript" src="{% static "app/js/jquery-3.6.1.min.js" %}"></script>#}
{#    <script type="text/javascript" src="{% static "app/lib/bootstrap-4.6.1/js/bootstrap.min.js" %}"></script>#}
{#{% endblock %}#}

{% block content %}
  <div class="actions">
    <a onclick="window.open('{% url "post_detail" %}')">
      <div class="action">投诉商家
      </div>
    </a> <a onclick="window.open('{% url "order_detail" %}')">
    <div class="action kf">订单查询</div>
  </a>
  </div>
<div class="container" style="margin: 190px auto;">
  <form class="layui-form" id="signup_form" method="post" action="{% url 'order_pay' %}">
    <div class="row mb-4">
      <div class="col-sm-5 left-card">
        <div class="card rounded-0">
          <div class="card-header text-center rounded-0 bg-primary-blue text-white">研狗插件</div>
          <div class="card-body">
            <p class="small-card">
              <span class="badge badge-light font-weight-normal">数字卡密</span>
              <span class="badge badge-light font-weight-normal">自动发货</span>
              <span class="badge badge-light font-weight-normal">信誉卖家</span>
            </p>
            <p class="text-muted" style="text-indent: -5rem;padding-left: 5rem"><b class="mr-3">联系卖家</b>微信:dotafeiying<br><small class="text-danger">商品问题联系卖家</small></p>
            <p class="text-muted"><b class="mr-3">卖家网站</b><a href="" class="text-primary">点击浏览</a></p>
            <p class="text-muted"><b class="mr-3">商品说明</b>
              <p>**填写联系方式是用于查询订单，提取解压密码，切勿乱填。。。。。。。。。。。。。
              **填写联系方式是用于查询订单，提取解压密码，切勿乱填。。。。。。。。。。。。。
              **填写联系方式是用于查询订单，提取解压密码，切勿乱填。。。。。。。。。。。。。</p>
            </p>
          </div>
        </div>
      </div>
      <div class="col-sm-7">
        {% csrf_token %}

        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="goods_name">商品名称</label>
            <p>{{ goods.name }}</p>
{#            <input type="email" class="form-control" id="inputEmail4">#}
          </div>
          <div class="form-group col-md-6">
            <label for="goods_price">商品单价</label>
            <p><b id="price" class="text-danger">{{ goods.price }}</b> 元</p>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="{{ form.total_count.id_for_label }}">购买数量</label>
{#            <input type="number" name="form.total_count" class="form-control" id="inputEmail4">#}
            {{ form.total_count|add_class:'form-control'|attr:"lay-filter:amountFilter"|attr:'oninput:if(value<0)value=0' }}
{#            {% render_field form.total_count rows="20" cols="20" title="Hello, world!" %}#}
          </div>
          <div class="form-group col-md-6">
            <label for="{{ form.email.id_for_label }}">联系方式</label>
            {{ form.email|add_class:'form-control'|attr:"lay-verify:email"|attr:"value:843514174@qq.com" }}
            <small id="email_help" class="form-text text-muted">{{ form.email.help_text }}</small>
          </div>
        </div>

        {% if redirect_field_value %}
          <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}"/>
        {% endif %}
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div class="card rounded-0">
          <div class="card-header p-0">
            <div class="float-left d-inline py-2 px-5 bg-primary-blue text-white">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-qr-code"
                   viewBox="0 0 16 16">
                <path d="M2 2h2v2H2V2Z"></path>
                <path d="M6 0v6H0V0h6ZM5 1H1v4h4V1ZM4 12H2v2h2v-2Z"></path>
                <path d="M6 10v6H0v-6h6Zm-5 1v4h4v-4H1Zm11-9h2v2h-2V2Z"></path>
                <path d="M10 0v6h6V0h-6Zm5 1v4h-4V1h4ZM8 1V0h1v2H8v2H7V1h1Zm0 5V4h1v2H8ZM6 8V7h1V6h1v2h1V7h5v1h-4v1H7V8H6Zm0 0v1H2V8H1v1H0V7h3v1h3Zm10 1h-1V7h1v2Zm-1 0h-1v2h2v-1h-1V9Zm-4 0h2v1h-1v1h-1V9Zm2 3v-1h-1v1h-1v1H9v1h3v-2h1Zm0 0h3v1h-2v1h-1v-2Zm-4-1v1h1v-2H7v1h2Z"></path>
                <path d="M7 12h1v3h4v1H7v-4Zm9 2v2h-3v-1h2v-1h1Z"></path>
              </svg>
              扫码支付
            </div>
            <div class="float-right d-inline py-2 px-3 " style="color: #f97c73">应付总额：<b id="amountShow">12.00</b>元</div>
          </div>
          <div class="card-body pay-type-body d-flex flex-row align-items-center">
            {% for value, displayable in form.pay_method.field.choices %}
              <div class="pay-type color-change p-3 {% if form.pay_method.value == value %} this {% endif %}" code="{{ value }}">
                {% if value == '1' %}
                  <img src="/static/app/images/payType/alipay.svg">
                {% elif value == '2' %}
                  <img src="/static/app/images/payType/wechat.svg">
                {% endif %}
                <span class="color-change {% if form.pay_method.value == value %} this {% endif %}">{{ displayable }}</span>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col d-flex justify-content-center mt-5">
        <button type="button" lay-submit lay-filter="pay" class="btn btn-primary">确认支付</button>
      </div>
    </div>
  </form>
</div>

{% endblock %}

{% block script %}
  <script>
    // 切换支付方式
		$(".pay-type").click(function () {
			$(".color-change").removeClass("this");
			$(this).addClass("this");
			$(this).find(".color-change").addClass("this");
		});
  </script>
  <script>
    layui.use(['layer', 'form'], function () {
      var form = layui.form;
      var layer = layui.layer;
      var index;
      var is_check_pay = false;

      form.on('submit(pay)', function (data) {
          is_check_pay = false
          var goods_id = {{ goods.id }}
          var total_count = data.field.total_count
          var email = data.field.email
          var csrf = data.field.csrfmiddlewaretoken
          const wayCode = $(".pay-type-body").find(".this").eq(0).attr("code");
          const reg = /^([1-9]\d{0,1}|0)(\.\d{1,2})?$/;
          if (!total_count || !reg.test(total_count) || total_count <= 0) {
              layer.alert('请输入正确的购买数量，0-100之间');
              return false;
          }
          var reqData = {};
          reqData.goods_id = goods_id;
          reqData.total_count = parseInt(total_count) || 0;
          reqData.email = email;
          reqData.pay_method = wayCode;
          reqData.total_price = $('#amountShow').text();
          reqData.csrfmiddlewaretoken = csrf;
          console.log(reqData);
          $.post('/order/commit', reqData, function (data) {
              console.log(data.res);
              if (data.res == 0) {
                  index = layer.open({
                      type: 1,
                      title: '支付信息',
                      area: 'auto',
                      maxWidth: '550',
                      content: data.data.html
                  });
              } else {
                  layer.alert(data.errmsg)
              }
          })
      })

      $(document).on('click', '#agree', function () {
        var csrf = $('input[name="csrfmiddlewaretoken"]').val()
        $.post('{% url "terms" %}', {'csrfmiddlewaretoken': csrf}, function (str) {
            layer.open({
                type: 1,
                title: '用户协议',
                area: 'auto',
                maxWidth: '800',
                content: str //注意，如果str是object，那么需要字符拼接。
            });
        });
      });

      $(document).on('click', '#order_pay', function () {
          is_check_pay = true
          var order_no = $('#order_pay').attr('order_no')
          var csrf = $('input[name="csrfmiddlewaretoken"]').val()
          var checked = $('input[name="agree"]').prop('checked')
          var params = {'order_no': order_no, 'checked': checked, 'csrfmiddlewaretoken': csrf}
          layer.close(index)
          $.ajax({
              url: '{% url "order_pay" %}',
              method: 'POST',
              headers:{'X-CSRFToken': csrf},
              data: JSON.stringify(params),
              contentType: 'application/json',
              success: function (data) {
                  if (data.res == 0) {
                      window.open(data.pay_url);
                      var getting = {
                          type: 'post',
                          url: '{% url "order_check" %}',
                          timeout: 30000,
                          data: params,
                          success: function (d) {
                              if (d.res == 0) {
                                  layer.confirm("<div>支付成功! <br>您的订单号为：" + order_no + "，点击确定获取卡密</div>", {title: '提示'}, function (index) {
                                      layer.close(index);
                                      window.open('{% url "order_detail" %}' + '?order_no=' + order_no)
                                  });
                              } else if (d.res == 3) {
                                  setTimeout(getData, 3000)
                              } else {
                                  layer.alert(d.errmsg)
                              }
                          },
                          error: function (XMLHttpRequest, textStatus, errorThrown) {
                              setTimeout(getData, 1000)
                          }
                      }

                      function getData() {
                          if (is_check_pay) {
                              $.ajax(getting);
                          }
                      }

                      getData()
                  } else {
                      layer.alert(data.errmsg)
                  }
              }
          })
          {% comment %}$.post('{% url "order_pay" %}', params, function (data) {
              if (data.res == 0) {
                  window.open(data.pay_url);
                  var getting = {
                      type: 'post',
                      url: '{% url "order_check" %}',
                      timeout: 30000,
                      data: params,
                      success: function (d) {
                          if (d.res == 0) {
                              layer.open({
                                  content: "<p>支付成功! <br>您的订单号为：" + order_no + "，点击确定获取卡密</p>",
                                  yes: function (index, layero) {
                                      layer.close(index); //如果设定了yes回调，需进行手工关闭
                                      window.open('{% url "order_detail" %}' + '?order_no=' + order_no)
                                  }
                              });
                              layer.confirm("<div>支付成功! <br>您的订单号为：" + order_no + "，点击确定获取卡密</div>", {title: '提示'}, function (index) {
                                  layer.close(index);
                                  window.open('{% url "order_detail" %}' + '?order_no=' + order_no)
                              });
                          } else if (d.res == 3) {
                              setTimeout(getData, 3000)
                          } else {
                              layer.alert(d.errmsg)
                          }
                      },
                      error: function (XMLHttpRequest, textStatus, errorThrown) {
                          setTimeout(getData, 1000)
                      }
                  }
                  function getData() {
                      if (is_check_pay) {
                          $.ajax(getting);
                      }
                  }
                  getData()
              } else {
                  layer.alert(data.errmsg)
              }
          }){% endcomment %}
      });

    })
    $(function () {
        $('#id_total_count').on('input', function (e) {
            var dprice = parseFloat($('#price').text()) || 0;
            var quantity = parseInt(e.target.value) || 0;
            var gprice = parseFloat(dprice * quantity).toFixed(2);
            $('#amountShow').text(gprice)
        })
    })

  </script>
{% endblock %}
